<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulir Entri Data</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    body {
      background-color: #111827;
      color: #f3f4f6;
    }
    .form-input {
      background-color: #374151;
      border-color: #4b5563;
      color: #f3f4f6;
    }
    .form-input::placeholder {
      color: #9ca3af;
    }
    .btn-submit {
      background-color: #1d4ed8;
    }
    .btn-submit:hover {
      background-color: #1e40af;
    }
    .table-header {
      background-color: #1f2937;
    }
    .table-row-dark {
      background-color: #374151;
    }
    .table-row-light {
        background-color: #4b5563;
    }
  </style>
</head>
<body class="antialiased">

  <div class="container mx-auto max-w-4xl p-4 sm:p-6 lg:p-8">
    <header class="text-center mb-8">
      <h1 class="text-3xl sm:text-4xl font-bold text-white tracking-tight">üìù Formulir Pengiriman Data</h1>
      <p class="text-gray-400 mt-2">Data akan diatur ulang (reset) jika server dimulai ulang.</p>
    </header>

    <section class="mb-8">
      <form id="data-form" class="bg-gray-800 p-6 rounded-lg shadow-lg grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end">
        <div>
          <label for="name" class="block text-sm font-medium text-gray-300 mb-1">Nama</label>
          <input type="text" id="name" name="name" class="form-input w-full rounded-md shadow-sm p-2" placeholder="Contoh: Levi Setiadi" required>
        </div>
        <div>
          <label for="wallet" class="block text-sm font-medium text-gray-300 mb-1">Dompet Digital</label>
          <input type="text" id="wallet" name="wallet" class="form-input w-full rounded-md shadow-sm p-2" placeholder="Contoh: DANA" required>
        </div>
        <div>
          <label for="nominal" class="block text-sm font-medium text-gray-300 mb-1">Nominal</label>
          <input type="number" id="nominal" name="nominal" class="form-input w-full rounded-md shadow-sm p-2" placeholder="Contoh: 50000" required>
        </div>
        <button type="submit" id="submit-button" class="btn-submit w-full text-white font-bold py-2 px-4 rounded-md flex items-center justify-center transition duration-300">
          <i class="fas fa-paper-plane mr-2"></i> Kirim
        </button>
      </form>
    </section>

    <section>
        <h2 class="text-2xl font-semibold mb-4 text-white">Data yang Telah Dikirim</h2>
        <div class="overflow-x-auto bg-gray-800 rounded-lg shadow-lg">
            <table class="min-w-full">
                <thead class="table-header">
                    <tr>
                        <th class="p-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Nama</th>
                        <th class="p-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Detail</th>
                        <th class="p-4 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Waktu</th>
                    </tr>
                </thead>
                <tbody id="data-table-body">
                </tbody>
            </table>
        </div>
         <div id="loading" class="text-center p-8 text-gray-400">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-2">Sedang memuat data...</p>
        </div>
    </section>
  </div>

  <script>
    const form = document.getElementById('data-form');
    const tableBody = document.getElementById('data-table-body');
    const submitButton = document.getElementById('submit-button');
    const loadingDiv = document.getElementById('loading');
    const originalButtonContent = submitButton.innerHTML;

    const toRupiah = (number) => {
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(number);
    };

    const renderData = (data = []) => {
        tableBody.innerHTML = '';
        loadingDiv.style.display = 'none';

        if (data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="3" class="text-center p-8 text-gray-500">Belum ada data yang tersimpan. Silakan kirim data terlebih dahulu.</td></tr>`;
            return;
        }

        data.forEach((item, index) => {
            const rowClass = index % 2 === 0 ? 'table-row-dark' : 'table-row-light';
            const row = `
                <tr class="${rowClass}">
                    <td class="p-4 whitespace-nowrap font-medium text-white">${item.name}</td>
                    <td class="p-4 whitespace-nowrap">
                        <div class="font-bold text-lg text-emerald-400">${toRupiah(item.nominal)}</div>
                        <div class="text-sm text-gray-400">${item.wallet}</div>
                    </td>
                    <td class="p-4 whitespace-nowrap text-right">
                         <div class="text-sm font-medium text-white">${item.jam}</div>
                         <div class="text-xs text-gray-400">${item.tanggal}</div>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    };

    const fetchData = async () => {
        try {
            loadingDiv.style.display = 'block';
            tableBody.innerHTML = '';
            
            const response = await fetch('/api/get');
            if (!response.ok) throw new Error('Gagal mengambil data dari server.');
            
            const result = await response.json();
            renderData(result.data);

        } catch (error) {
            console.error('Error:', error);
            loadingDiv.style.display = 'none';
            tableBody.innerHTML = `<tr><td colspan="3" class="text-center p-8 text-red-400">Terjadi Kesalahan: Gagal terhubung ke API. Silakan periksa konsol.</td></tr>`;
        }
    };

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = document.getElementById('name').value;
        const wallet = document.getElementById('wallet').value;
        const nominal = document.getElementById('nominal').value;

        const now = new Date();
        const jam = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const tanggal = now.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric'});

        const formData = { name, wallet, nominal: parseInt(nominal), jam, tanggal };
        
        submitButton.disabled = true;
        submitButton.innerHTML = `<i class="fas fa-circle-notch fa-spin mr-2"></i> Memproses...`;

        try {
            const response = await fetch('/api/post', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (!response.ok) throw new Error('Gagal mengirimkan data.');

            const result = await response.json();
            
            form.reset();
            await fetchData();

        } catch (error) {
            console.error('Error:', error);
            alert('Gagal mengirimkan data. Silakan coba kembali.');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonContent;
        }
    });

    document.addEventListener('DOMContentLoaded', fetchData);
  </script>
</body>
</html>
